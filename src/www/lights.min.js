var storage,hue={};
function setHueUrls(){hue.getUrl="http://"+hue.ip+"/api/"+hue.userId+"/lights/"+hue.lightNo;hue.putUrl=hue.getUrl+"/state"}
function doStuff(a,c,b){var d=new XMLHttpRequest;d.onreadystatechange=function(){if(4===this.readyState&&200===this.status){var a=JSON.parse(this.responseText);"function"===typeof c&&c(a[0])}};d.onerror=function(){"function"===typeof b&&b(this)};d.open("PUT",hue.putUrl,!0);d.send("string"===typeof a?a:JSON.stringify(a))}
function getStuff(a,c){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(4===this.readyState&&200===this.status){var b=JSON.parse(this.responseText);b[0]&&b[0].error?(console.log("An error occurred when getting data from the Hue Bridge:\n"+b[0].error.description),"function"===typeof c&&c(b[0].error)):"function"===typeof a&&a(b.state)}};b.onerror=function(){"function"===typeof c&&c(this)};b.open("GET",hue.getUrl);b.timeout=3e4;b.ontimeout=b.onerror;b.send()}
function getAllLights(a,c){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(4===this.readyState&&200===this.status){var b=JSON.parse(this.responseText);b[0]&&b[0].error?(console.log("An error occurred when getting data from the Hue Bridge:\n"+b[0].error.description),"function"===typeof c&&c(b[0].error)):"function"===typeof a&&a(b)}};b.onerror=function(){"function"===typeof c&&c(this)};b.open("GET",hue.getUrl.replace(/\/\d+$/,""));b.send()}
function getBridgeIp(a,c){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(4===this.readyState&&200===this.status){var b=JSON.parse(this.responseText);"function"===typeof a&&a(b)}};b.onerror=function(){"function"===typeof c&&c(this)};b.open("GET","https://www.meethue.com/api/nupnp");b.timeout=3e4;b.ontimeout=b.onerror;b.send()}
function createNewDeveloper(a,c,b){function d(){h.open("POST","http://"+hue.ip+"/api");h.send(JSON.stringify({devicetype:"hue-controller#node"}))}var h=new XMLHttpRequest;h.onreadystatechange=function(){if(4===this.readyState&&200===this.status){var b=JSON.parse(this.responseText);b[0]&&b[0].error&&101===b[0].error.type?("function"===typeof a&&a(b[0].error),setTimeout(d,1E3)):b[0]&&b[0].success&&"function"===typeof c&&c(b[0].success)}};h.onerror=function(){"function"===typeof b&&b(this)};d()}
function dispatchStartBridgeSearchEvent(a){document.dispatchEvent(new window.CustomEvent("huebridgesearchstart",{detail:a}))}
function dispatchBridgeIpFoundEvent(a){document.dispatchEvent(new window.CustomEvent("huebridgeip",{detail:a}))}
function dispatchConnectionEvent(a){document.dispatchEvent(new window.CustomEvent("hueconnection",{detail:a}))}
function dispatchErrorEvent(a){document.dispatchEvent(new window.CustomEvent("hueerror",{detail:a}))}
function dispatchLinkButtonEvent(a){document.dispatchEvent(new window.CustomEvent("huelinkbutton",{detail:a}))}function establishConnection(){getStuff(function(a){dispatchConnectionEvent(a)},function(a){dispatchErrorEvent(a)})}
function firstTimeSetup(){dispatchStartBridgeSearchEvent();getBridgeIp(function(a){a&&0===a.length?(console.error("UPnP returned empty array."),dispatchErrorEvent({description:"Could not find any Hue bridges on the local network"})):a&&a[0]&&a[0].internalipaddress?(hue.ip=a[0].internalipaddress,console.log("Hue Bridge found at IP "+hue.ip),dispatchBridgeIpFoundEvent(a[0]),createNewDeveloper(function(a){dispatchLinkButtonEvent(a)},function(a){hue.userId=a.username;console.log("New username created: "+hue.userId);hue.lightNo="2";setHueUrls();storage.set({hue:hue});establishConnection()},function(a){a.description="POST request to Hue Bridge failed.";console.error(a.description);dispatchErrorEvent(a)})):(console.error("Bridge IP address search failed"),dispatchErrorEvent({description:"Bridge IP Address search failed. Check internet connection."}))},function(a){a.description="No internet connection.";console.error(a.description);dispatchErrorEvent(a)})}
function clamp(a,c,b){return a<c?c:a>b?b:a}
function hsv2rgb(a,c,b){var d,h,e,n,q,f,m;1===arguments.length&&(c=a.s,b=a.v,a=a.h);n=6*a|0;q=6*a-n;f=b*(1-c);m=b*(1-q*c);q=b*(1-(1-q)*c);switch(n%6){case 0:d=b;h=q;e=f;break;case 1:d=m;h=b;e=f;break;case 2:d=f;h=b;e=q;break;case 3:d=f;h=m;e=b;break;case 4:d=q;h=f;e=b;break;case 5:d=b,h=f,e=m}return{r:255*d|0,g:255*h|0,b:255*e|0}}
function rgb2hsv(a,c,b){1===arguments.length&&(c=a.g,b=a.b,a=a.r);a/=255;c/=255;b/=255;var d,h,e,n,q,f=Math.max(a,c,b);e=f-Math.min(a,c,b);0===e?n=q=0:(q=e/f,d=(f-a)/6/e+.5,h=(f-c)/6/e+.5,e=(f-b)/6/e+.5,a===f?n=e-h:c===f?n=1/3+d-e:b===f&&(n=2/3+h-d),0>n?n+=1:1<n&&--n);return{h:n,s:q,v:f}}
function hex2hsv(a){"string"===typeof a&&(a=parseInt(a.replace(/^#/,""),16));return rgb2hsv((a&16711680)>>16,(a&65280)>>8,(a&255)>>0)}
function rgb2hex(a,c,b){1===arguments.length&&(c=a.g,b=a.b,a=a.r);return"#"+("00000"+((a<<16)+(c<<8)+b).toString(16)).slice(-6)}
function hsv2hex(a,c,b){var d;1===arguments.length&&(c=a.s,b=a.v,a=a.h);d=hsv2rgb(a,c,b);return rgb2hex(d)}
function ct2rgb(a){a/=100;var c,b;66>=a?(c=255,b=99.4708025861*Math.log(a)-161.1195681661,a=19>=a?0:138.5177312231*Math.log(a-10)-305.0447927307):(c=329.698727446*Math.pow(a-60,-.1332047592),b=288.1221695283*Math.pow(a-60,-.0755148492),a=255);return{r:clamp(c,0,255)|0,g:clamp(b,0,255)|0,b:clamp(a,0,255)|0}}
function toggle(){getStuff(function(a){doStuff({on:!a.on})})}
function setColour(a){var c=hex2hsv(a);a="string"===typeof a?a:"#"+("00000"+a.toString(16)).slice(-6);doStuff({hue:65535*c.h|0,sat:255*c.s|0,bri:255*c.v|0});document.body.style.backgroundColor=a}
function fadeInAnimation(a,c,b){a.style.transition="opacity "+c+"ms";a.style.opacity=0;setTimeout(function(){"function"===typeof b&&b();a.style.opacity=1},c)}
function showElement(a){a.classList.remove("hidden")}
function hideElement(a){a.classList.add("hidden")}
function isHidden(a){return a.classList.contains("hidden")}
function initialiseColourWheel(){function a(a,b){var c="string"===typeof a?a:"#"+("00000"+a.toString(16)).slice(-6);b=b||hex2hsv(a);k.h=b.h;k.s=b.s;k.v=b.v;"temperature"===O[L]?doStuff({ct:b.ct,bri:255*b.v|0}):doStuff({hue:65535*b.h|0,sat:255*b.s|0,bri:255*b.v|0});document.body.style.backgroundColor=c;v&&(v.value=c)}function c(){var b=4*(400*H.y+H.x);0!==g.data[b+3]&&(k.r=g.data[b],k.g=g.data[b+1],k.b=g.data[b+2],k.a=g.data[b+3],b=rgb2hsv(k),k.h=b.h,k.s=b.s,k.v=b.v,b=(k.r<<16)+(k.g<<8)+k.b,"temperature"===O[L]&&"colour"===P[B]&&(k.ct=347*(1-H.y/400)+153|0),a(b,k))}function b(){switch(P[B]){case "colour":switch(O[L]){case "hue-sat":var a,b,c;for(l=0;l<g.data.length;l+=4)x=l/4%400|0,w=l/4/400|0,y=Math.sqrt(Math.pow(x-200,2)+Math.pow(w-200,2)),202<=y?(g.data[l]=0,g.data[l+1]=0,g.data[l+2]=0,g.data[l+3]=0):(T=Math.atan2(w-200,x-200),a=T/(2*Math.PI),0>a&&(a+=1),b=y/200,c=k.v,a=hsv2rgb(a,b,c),g.data[l]=a.r,g.data[l+1]=a.g,g.data[l+2]=a.b,g.data[l+3]=255);break;case "temperature":for(a=0;a<g.data.length;a+=4)x=a/4%400|0,w=a/4/400|0,y=Math.sqrt(Math.pow(x-200,2)+Math.pow(w-200,2)),202<=y?(g.data[a]=0,g.data[a+1]=0,g.data[a+2]=0,g.data[a+3]=0):(b=w/400*5E3+2E3,b=ct2rgb(b),g.data[a]=b.r*k.v|0,g.data[a+1]=b.g*k.v|0,g.data[a+2]=b.b*k.v|0,g.data[a+3]=255);break;case "image":I.drawImage(z,0,0,400,400),g=I.getImageData(0,0,400,400)}break;case "bri":for(l=0;l<g.data.length;l+=4)x=l/4%400|0,w=l/4/400|0,y=Math.sqrt(Math.pow(x-200,2)+Math.pow(w-200,2)),202<=y?(g.data[l]=0,g.data[l+1]=0,g.data[l+2]=0,g.data[l+3]=0):(a=k.h,b=k.s,c=Math.max(1-w/400,.01),a=hsv2rgb(a,b,c),g.data[l]=a.r,g.data[l+1]=a.g,g.data[l+2]=a.b,g.data[l+3]=255)}I.putImageData(g,0,0)}function d(){B=(B+1)%P.length;fadeInAnimation(J,100,b)}function h(a){var b=r.getBoundingClientRect();H.x=(a.clientX||a.targetTouches[0].pageX)-b.left|0;H.y=(a.clientY||a.targetTouches[0].pageY)-b.top|0}function e(a){h(a);c();clearInterval(Q);Q=setInterval(c,100)}function n(a){h(a)}function q(a){clearInterval(Q)}function f(c){var d=k.v;c.preventDefault();d+=c.wheelDelta/2E3;d=clamp(d,.01,1);k.v=d;b();c=hsv2hex(k);a(c,k)}function m(){t&&hideElement(t)}function u(a,c){var d=a.parentElement.children,g;for(g=0;g<d.length;g+=1)d[g].classList.remove("selected");a.classList.add("selected");L=c;B=0;2!==c&&m();b()}function R(a){a=a.detail;k.h=a.hue/65535;k.s=a.sat/255;k.v=Math.max(a.bri/255,.02);a=hsv2rgb(k);k.r=a.r;k.g=a.g;k.b=a.b;a=rgb2hex(a);document.body.style.backgroundColor=a;v&&(v.value=a);b()}function S(a){}var M=document.getElementById("toggle"),v=document.getElementById("colour"),J=document.getElementById("colour-wheel"),C=document.getElementById("mode"),D=document.getElementById("reset-button");document.getElementById("carousel");document.getElementById("carousel-selection");var E=document.getElementById("carousel-colour-wheel"),F=document.getElementById("carousel-ct"),A=document.getElementById("carousel-image"),N=document.getElementById("carousel-gamut"),K=document.getElementById("carousel-colour-loop"),t=document.getElementById("image-gallery"),p=document.getElementById("add-image"),U=t.getElementsByClassName("close")[0],G,r,I,g,l,x,w,y,T,B=0,P=["colour","bri"],L=0,O=["hue-sat","temperature","image","gamut","loop"],k={h:0,s:0,v:1,hex:16777215,r:255,g:255,b:255,a:255,ct:500},H={x:0,y:0},Q,z=new Image;M&&M.addEventListener("click",toggle);v&&v.addEventListener("change",function(){a(v.value);b()});C&&C.addEventListener("click",d);D&&D.addEventListener("click",function(){a(13237870);b()});J&&(r=document.createElement("canvas"),r.width=400,r.height=400,J.appendChild(r),I=r.getContext("2d"),g=I.getImageData(0,0,400,400),b(),document.addEventListener("hueconnection",R,!1),document.addEventListener("hueerror",S,!1),r.addEventListener("mousedown",e,!1),r.addEventListener("mousemove",n,!1),r.addEventListener("mouseup",q,!1),document.body.addEventListener("mouseout",q,!1),r.addEventListener("touchstart",e,!1),r.addEventListener("touchmove",n,!1),r.addEventListener("touchend",q,!1),r.addEventListener("mousewheel",f,!1),r.addEventListener("dblclick",d,!1));E&&E.addEventListener("click",function(a){u(a.target,0)},!1);F&&F.addEventListener("click",function(a){u(a.target,1)},!1);A&&(A.addEventListener("click",function(a){t&&showElement(t);u(a.target,2)},!1),U&&U.addEventListener("click",function(a){m()}),r&&t&&(r.addEventListener("mousedown",m,!1),r.addEventListener("touchstart",m,!1)));p&&p.addEventListener("click",function(a){z=new Image;z.onload=function(){t&&t.children[0]&&(t.children[0].appendChild(z),z.addEventListener("click",function(a){z=a.target;B=0;b()},!1));u(a.target,2)};void 0===G&&(G=document.createElement("input"),G.setAttribute("type","file"),G.setAttribute("accept","image/*"),G.onchange=function(a){z.src=window.URL.createObjectURL(a.path[0].files[0])});G.click()},!1);N&&N.addEventListener("click",function(a){u(a.target,3)},!1);K&&K.addEventListener("click",function(a){u(a.target,4)},!1)}
function initialiseAnimationsPane(){function a(a){var b=a.target.parentElement.parentElement.getElementsByClassName("val-td")[0].getElementsByTagName("input"),c;for(c=0;c<b.length;c+=1)hideElement(b[c]);switch(a.target.value){case "Colour":showElement(b[0]);break;case "On/Off":showElement(b[1]);break;case "Hue":case "Saturation":case "Brightness":case "Temperature":showElement(b[2])}}function c(a){a=a.target.parentElement.parentElement;a.parentElement.removeChild(a)}function b(){A.innerHTML=p.on?"play_arrow":"clear"}function d(a){var b=f.getBoundingClientRect();a=a.getBoundingClientRect();var c=a.top-b.top;A.style.left=a.left-b.left+-14+"px";A.style.top=c+1+"px";A.style.color=hsv2hex(p.hsv)}function h(a){if(0<a&&a<m.rows.length-1){var c=m.rows[a],f=c.cells[0].getElementsByClassName("param")[0].value,e=c.cells[1].getElementsByClassName("val"),g=1E3*parseFloat(c.cells[2].getElementsByClassName("time")[0].value,10);if(p.on||"On/Off"===f)switch(f){case "Colour":p.hsv=hex2hsv(e[0].value);doStuff({hue:65535*p.hsv.h|0,sat:255*p.hsv.s|0,bri:255*p.hsv.v|0});break;case "Hue":p.hsv.h=parseFloat(e[2].value);doStuff({hue:65535*p.hsv.h|0});break;case "Saturation":p.hsv.s=parseFloat(e[2].value);doStuff({sat:255*p.hsv.s|0});break;case "Brightness":p.hsv.v=parseFloat(e[2].value);doStuff({bri:255*p.hsv.v|0});break;case "Temperature":doStuff({ct:347*parseFloat(e[2].value)+153|0});break;case "Random":p.hsv={h:Math.random(),s:Math.random(),v:Math.random()};doStuff({hue:65535*p.hsv.h|0,sat:255*p.hsv.s|0,bri:255*p.hsv.v|0});break;case "On/Off":p.on=e[1].checked,doStuff({on:p.on}),b()}d(c);F&&(E=setTimeout(function(){h(a+1)},g))}else N.classList.contains("checked")&&h(1)}function e(){F=!1;f.classList.remove("playing");clearTimeout(E);showElement(C);hideElement(D)}function n(){hideElement(f);e()}function q(a){a.target.classList.contains("checked")?a.target.classList.remove("checked"):a.target.classList.add("checked")}var f=document.getElementById("anim"),m=document.getElementById("anim-table"),u=f.getElementsByTagName("tbody")[0],R=document.getElementById("show-anim"),S=document.getElementById("add-frame"),M=f.getElementsByClassName("param")[0];f.getElementsByClassName("val");var v=f.getElementsByClassName("delete-row")[0],J=f.getElementsByClassName("close")[0],C=document.getElementById("play-animation"),D=document.getElementById("stop-animation"),E,F=!0,A=document.getElementById("frame-indicator"),N=document.getElementById("loop-anim"),K=document.getElementsByClassName("toggle"),t,p={hsv:{h:0,s:0,v:1},on:!0};for(t=0;t<K.length;t+=1)K[t].addEventListener("click",q,!1);M.addEventListener("change",a,!1);v.addEventListener("click",c,!1);R.addEventListener("click",function(){isHidden(f)?showElement(f):n()},!1);J.addEventListener("click",n,!1);S.addEventListener("click",function(){var b=m.rows.length-2,d=m.rows[b],e=d.cloneNode(!0),b=m.rows[b+1];e.getElementsByClassName("delete-row")[0].addEventListener("click",c,!1);e.getElementsByClassName("param")[0].addEventListener("change",a);e.getElementsByClassName("param")[0].value=d.getElementsByClassName("param")[0].value;u.insertBefore(e,b)},!1);C.addEventListener("click",function(){clearTimeout(E);F=!0;f.classList.add("playing");getStuff(function(a){p={hsv:{h:a.hue/65535,s:a.sat/255,v:a.bri/255},on:a.on};b();h(1)},function(a){window.alert("An error occurred when getting data from the Hue Bridge:\n"+a.description);p.on=!1;b();h(1)});hideElement(C);showElement(D)},!1);D.addEventListener("click",e,!1)}
function initialiseSettingsPanel(){function a(a,b,c){m.innerHTML=a;m.classList.remove("fade-out");switch(b){case "info":m.style.color="#6FC";break;case "error":m.style.color="#F44";break;default:m.style.color="#CCC"}clearTimeout(u);u=setTimeout(function(){m.classList.add("fade-out")},c||5E3)}function c(){hue.ip=d.value||"192.168.0.0";hue.userId=h.value||"undefined--clear-data-and-reload-to-create-new";hue.lightNo=e.value||1;setHueUrls()}function b(){getAllLights(function(b){var c,f=[];e.innerHTML="";for(c in b)b.hasOwnProperty(c)&&(e.innerHTML+='<option value="'+c+'">'+b[c].name+"</option>",f.push(b[c].name));0<f.length?a("Lights found: "+f.join(", "),"info"):a("Connected, but list of lights was empty.","error");d.value=hue.ip;h.value=hue.userId;e.value=hue.lightNo},function(b){e.innerHTML='<option value="" selected>&lt;No lights found&gt;</option>';a("The following error occurred: "+b.description,"error")})}var d=document.getElementById("hue-ip"),h=document.getElementById("hue-username"),e=document.getElementById("hue-light-no"),n=document.getElementById("hue-test"),q=document.getElementById("hue-save"),f=document.getElementById("hue-clear"),m=document.getElementById("hue-messages"),u;document.addEventListener("huebridgeip",function(a){d.value=a.detail.internalipaddress});document.addEventListener("hueconnection",b);document.addEventListener("hueerror",function(a){d.value=hue.ip;h.value=hue.userId});d.addEventListener("change",function(){hue.ip=d.value;setHueUrls()},!1);h.addEventListener("change",function(){hue.userId=h.value;setHueUrls()},!1);e.addEventListener("change",function(){hue.lightNo=e.value;setHueUrls()},!1);n.addEventListener("click",function(){c();a("Searching for lights...","other",2E4);b()});q.addEventListener("click",function(){c();storage.set({hue:hue});a("Changes saved.","info");establishConnection()},!1);f.addEventListener("click",function(){storage.clear();a("Settings cleared.","info")},!1)}
function initialiseConnectingSplashscreen(){function a(){b&&hideElement(b);window.alert("Please note: Hue lights will not respond until the connection is made.\nWill continue trying to connect in the background.")}function c(){storage.clear();firstTimeSetup();showElement(e);hideElement(n)}var b=document.getElementById("connecting"),d=document.getElementById("connecting-message"),h=document.getElementById("connecting-skip"),e=document.getElementById("connecting-spinner"),n=document.getElementById("connecting-error"),q=document.getElementById("connecting-error-message"),f=document.getElementById("connecting-timed-out"),m=document.getElementById("connecting-retry");h&&h.addEventListener("click",a,!1);m&&m.addEventListener("click",c,!1);document.addEventListener("hueconnection",function(a){b&&hideElement(b)});document.addEventListener("hueerror",function(a){a=a.detail;a.detail||a.description?(q.innerHTML=a.detail||a.description,hideElement(f)):(q.innerHTML="Connection timed out.",showElement(f));hideElement(e);showElement(n)});document.addEventListener("huelinkbutton",function(a){d.innerHTML="Please press the link button on the Hue Bridge..."});document.addEventListener("huebridgeip",function(a){d.innerHTML="Connecting to Hue Bridge..."});document.addEventListener("huebridgesearchstart",function(a){d.innerHTML="Searching for Hue Bridges..."})}
function LocalDataStorage(){try{this.storageType="local",window.localStorage.available=!0}catch(a){this.storageType="chrome";try{chrome.storage.local.set({available:!0})}catch(c){this.storageType="unavailable",console.error("Storage unavailable")}}this.get=function(a){var c,b;switch(this.storageType){case "local":b={};for(c in window.localStorage)window.localStorage.hasOwnProperty(c)&&(b[c]=JSON.parse(window.localStorage[c]));"function"===typeof a&&a(b);break;case "chrome":chrome.storage.local.get(null,
function(b){"function"===typeof a&&a(b)})}};this.set=function(a,c){var b;switch(this.storageType){case "local":for(b in a)a.hasOwnProperty(b)&&(window.localStorage[b]=JSON.stringify(a[b]));console.log("Saved to local storage.");break;case "chrome":chrome.storage.local.set(a,function(){console.log("Saved to chrome storage.")})}};this.clear=function(){switch(this.storageType){case "local":window.localStorage.clear();console.log("Local storage cleared.");break;case "chrome":chrome.storage.local.clear(function(){console.log("Chrome storage cleared.")})}}}
function initialise(){initialiseConnectingSplashscreen();initialiseColourWheel();initialiseAnimationsPane();initialiseSettingsPanel();storage=new LocalDataStorage;storage.get(function(a){a.hue?(hue=a.hue,establishConnection()):firstTimeSetup()})}document.addEventListener("DOMContentLoaded",initialise,!1);